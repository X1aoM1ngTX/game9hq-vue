<template>
  <div id="gamesManagePage">
    <a-input-search
      v-model:value="searchValue"
      enter-button="ÊêúÁ¥¢üîç"
      placeholder="ËæìÂÖ•Ê∏∏ÊàèÂêçÊêúÁ¥¢üîç"
      size="large"
      @search="onSearch"
    />
    <a-table :columns="columns" :data-source="data">
      <template #bodyCell="{ column, record }">
        <template v-if="column.key === 'gameIsRemoved'">
          <a-tag :color="record.gameIsRemoved === true ? 'red' : 'green'">
            {{ record.gameIsRemoved === true ? "Â∑≤‰∏ãÊû∂" : "Â∑≤‰∏äÊû∂" }}
          </a-tag>
        </template>
        <template v-else-if="column.key === 'gamePrice'">
          <a-tag :color="record.gamePrice === 0 ? 'blue' : 'default'">
            {{ record.gamePrice === 0 ? "ÂÖçË¥π" : record.gamePrice + "Ôø•" }}
          </a-tag>
        </template>
        <template v-else-if="column.key === 'gameDiscountedPrices'">
          <template v-if="record.gameOnSale !== 0">
            <a-tag :color="record.gameOnSale === 0 ? 'default' : 'green'">
              {{ record.gameDiscountedPrices + "Ôø•" }}
            </a-tag>
          </template>
        </template>
        <template v-else-if="column.key === 'action'">
          <a-space :direction="'vertical'">
            <a-button type="primary" @click="showEditModal(record)"
              >ÁºñËæë
            </a-button>
            <a-button type="default" @click="toggleStatus(record)">
              {{ record.gameIsRemoved === true ? "‰∏äÊû∂" : "‰∏ãÊû∂" }}
            </a-button>
            <a-button danger @click="doDelete(record.gameId)">Âà†Èô§</a-button>
          </a-space>
        </template>
      </template>
    </a-table>
    <a-modal
      v-model:visible="modalVisible"
      :title="modalTitle"
      @ok="handleModalOk"
      @cancel="handleModalCancel"
      :destroyOnClose="true"
    >
      <a-form :model="formState" layout="vertical">
        <a-form-item
          label="Ê∏∏ÊàèÂêçÁß∞"
          name="gameName"
          :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•Ê∏∏ÊàèÂêçÁß∞!' }]"
        >
          <a-input v-model:value="formState.gameName" />
        </a-form-item>
        <a-form-item
          label="Ê∏∏ÊàèÂ∞ÅÈù¢"
          name="gameCover"
          :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•Ê∏∏ÊàèÂ∞ÅÈù¢Âú∞ÂùÄ!' }]"
        >
          <a-upload
            name="gameCover"
            list-type="picture-card"
            class="avatar-uploader"
            :show-upload-list="false"
            :before-upload="beforeUpload"
            @change="handleChange"
          >
            <img
              v-if="formState.gameCover"
              :src="formState.gameCover"
              alt="avatar"
              style="width: 100%"
            />
            <div v-else>
              <plus-outlined />
              <div class="ant-upload-text">Upload</div>
            </div>
          </a-upload>
        </a-form-item>
        <a-form-item label="Ê∏∏ÊàèÊèèËø∞" name="gameDescription">
          <a-textarea v-model:value="formState.gameDescription" />
        </a-form-item>
        <a-form-item
          label="Ê∏∏Êàè‰ª∑Ê†º"
          name="gamePrice"
          :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•Ê∏∏Êàè‰ª∑Ê†º!' }]"
        >
          <a-input-number
            v-model:value="formState.gamePrice"
            :min="0"
            :precision="2"
            style="width: 100%"
          />
        </a-form-item>
        <a-form-item
          label="Ê∏∏ÊàèÂ∫ìÂ≠ò"
          name="gameStock"
          :rules="[{ required: true, message: 'ËØ∑ËæìÂÖ•Ê∏∏ÊàèÂ∫ìÂ≠ò!' }]"
        >
          <a-input-number
            v-model:value="formState.gameStock"
            :min="0"
            style="width: 100%"
          />
        </a-form-item>
        <a-form-item label="Ê∏∏ÊàèÂèëË°åÂïÜ" name="gamePub">
          <a-input v-model:value="formState.gamePub" />
        </a-form-item>
        <a-form-item label="ÂèëË°åÊó•Êúü" name="gameReleaseDate">
          <a-date-picker
            v-model:value="formState.gameReleaseDate"
            style="width: 100%"
          />
        </a-form-item>
        <a-form-item label="Ê∏∏ÊàèÂºÄÂèëÂïÜ" name="gameDev">
          <a-input v-model:value="formState.gameDev" />
        </a-form-item>
        <a-form-item label="ÊòØÂê¶ÊâìÊäò" name="gameOnSale">
          <a-switch
            v-model:checked="formState.gameOnSale"
            :checkedValue="true"
            :unCheckedValue="false"
            checked-children="ÊòØ"
            un-checked-children="Âê¶"
            @change="handleSaleStatusChange"
          />
        </a-form-item>
        <a-form-item label="Ê∏∏ÊàèÊäòÊâ£ÂºÄÂßãÊó∂Èó¥" name="gameSaleStartTime">
          <a-date-picker
            v-model:value="formState.gameSaleStartTime"
            :show-time="true"
            format="YYYY-MM-DD HH:mm:ss"
            style="width: 100%"
            @change="handleStartTimeChange"
          />
        </a-form-item>
        <a-form-item
          label="Ê∏∏ÊàèÊäòÊâ£ÁªìÊùüÊó∂Èó¥"
          name="gameSaleEndTime"
          :rules="[
            { validator: validateEndTime, message: 'ÁªìÊùüÊó∂Èó¥‰∏çËÉΩÊó©‰∫éÂºÄÂßãÊó∂Èó¥' },
          ]"
        >
          <a-date-picker
            v-model:value="formState.gameSaleEndTime"
            :show-time="true"
            format="YYYY-MM-DD HH:mm:ss"
            style="width: 100%"
          />
        </a-form-item>
        <a-form-item
          label="Ê∏∏ÊàèÊäòÊâ£"
          name="gameDiscount"
          :rules="[
            { required: true, message: 'ËØ∑ËæìÂÖ•Ê∏∏ÊàèÊäòÊâ£!' },
            { type: 'number', min: 0, max: 1, message: 'ÊäòÊâ£ÂøÖÈ°ªÂú®0-1‰πãÈó¥!' },
          ]"
        >
          <a-input-number
            v-model:value="formState.gameDiscount"
            :min="0"
            :max="1"
            :step="0.1"
            :precision="2"
            style="width: 100%"
            placeholder="ËæìÂÖ•0.2Ë°®Á§∫Êâì8Êäò"
            @change="handleDiscountChange"
          />
        </a-form-item>
      </a-form>
    </a-modal>
  </div>
</template>

<script lang="ts" setup>
// ÂØºÂÖ•ÊâÄÈúÄÁöÑÁªÑ‰ª∂ÂíåÂáΩÊï∞
import { reactive, ref } from "vue";
import { message, Modal } from "ant-design-vue";
import {
  deleteGame,
  searchGames,
  updateGame,
  updateGameStatus,
} from "@/api/game";
// ÂØºÂÖ•Êó•ÊúüÂ§ÑÁêÜÂ∫ì
import dayjs from "dayjs";
import "dayjs/locale/zh-cn";
import { PlusOutlined } from "@ant-design/icons-vue"; // Ê∑ªÂä†ÂõæÊ†áÁªÑ‰ª∂

// ËÆæÁΩÆ dayjs ‰∏∫‰∏≠Êñá
dayjs.locale("zh-cn");

// ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
const searchValue = ref("");
// ÊêúÁ¥¢Â§ÑÁêÜÂáΩÊï∞
const onSearch = (value: string) => {
  fetchData(value);
};

// Âà†Èô§Ê∏∏ÊàèÂ§ÑÁêÜÂáΩÊï∞
const doDelete = (gameId: string) => {
  if (!gameId) return;

  // Á°ÆËÆ§Ê°Ü
  Modal.confirm({
    title: "Á°ÆËÆ§Âà†Èô§", // ÂØπËØùÊ°ÜÊ†áÈ¢ò
    content: "Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê∏∏ÊàèÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ", // ÂØπËØùÊ°ÜÂÜÖÂÆπ
    okText: "Á°ÆËÆ§", // Á°ÆËÆ§ÊåâÈíÆÁöÑÊñáÊú¨
    cancelText: "ÂèñÊ∂à", // ÂèñÊ∂àÊåâÈíÆÁöÑÊñáÊú¨
    async onOk() {
      // Áî®Êà∑ÁÇπÂáª"Á°ÆËÆ§"Êó∂ÁöÑÂõûË∞ÉÂáΩÊï∞
      const res = await deleteGame(gameId); // Ë∞ÉÁî®Âà†Èô§Ê∏∏ÊàèÁöÑÊé•Âè£
      if (res.data.code === 0) {
        // Âà§Êñ≠Âà†Èô§ÊòØÂê¶ÊàêÂäü
        message.success("Âà†Èô§ÊàêÂäü");
        await fetchData(searchValue.value); // Âà∑Êñ∞Êï∞ÊçÆ
      } else {
        message.error("Âà†Èô§Â§±Ë¥•");
      }
    },
    onCancel() {
      // Áî®Êà∑ÁÇπÂáª"ÂèñÊ∂à"Êó∂ÁöÑÂõûË∞ÉÂáΩÊï∞
      return; // Áõ¥Êé•ËøîÂõûÔºå‰∏çÊâßË°å‰ªª‰ΩïÊìç‰Ωú
    },
  });
};

interface GameTableRecord {
  gameOnSale: number;
  gameDiscount: number;
  gamePrice: number;
  gameDiscountedPrices: number | null;
  gameCover: string;
}

// Ë°®Ê†ºÂàóÂÆö‰πâ
const columns = [
  {
    title: "Ê∏∏ÊàèIDüéÆ",
    dataIndex: "gameId",
    key: "gameId",
  },
  {
    title: "Ê∏∏ÊàèÂêçÁß∞üéØ",
    dataIndex: "gameName",
    key: "gameName",
  },
  {
    title: "Ê∏∏ÊàèÊèèËø∞üìù",
    dataIndex: "gameDescription",
    key: "gameDescription",
  },
  {
    title: "Ê∏∏ÊàèÂ∫ìÂ≠òüì¶",
    dataIndex: "gameStock",
    key: "gameStock",
  },
  {
    title: "Ê∏∏ÊàèÂèëË°åÊó•üìÖ",
    dataIndex: "gameReleaseDate",
    key: "gameReleaseDate",
  },
  {
    title: "Ê∏∏ÊàèÂºÄÂèëÂïÜüíª",
    dataIndex: "gameDev",
    key: "gameDev",
  },
  {
    title: "Ê∏∏ÊàèÂèëË°åÂïÜüì§",
    dataIndex: "gamePub",
    key: "gamePub",
  },
  {
    title: "Ê∏∏ÊàèÂ∞ÅÈù¢",
    dataIndex: "gameCover",
    key: "gameCover",
    customRender: ({ record }: { record: GameTableRecord }) => {
      return `<img src="${record.gameCover}" alt="Game Cover" style="width: 50px; height: 50px;"/>`;
    },
  },
  {
    title: "Ê∏∏Êàè‰ª∑Ê†ºüí∞",
    dataIndex: "gamePrice",
    key: "gamePrice",
    customRender: ({ record }: { record: GameTableRecord }) => {
      if (record.gamePrice === 0) {
        return "ÂÖçË¥π";
      }
    },
  },
  {
    title: "ÊäòÊâ£Áä∂ÊÄÅ üíπ",
    key: "gameOnSale",
    dataIndex: "gameOnSale",
    customRender: ({ record }: { record: GameTableRecord }) => {
      if (record.gamePrice === 0) {
        return "-";
      }
      if (record.gameOnSale === 1) {
        return `${((1 - record.gameDiscount) * 100).toFixed(1)}%`;
      }
      return "Êó†ÊäòÊâ£";
    },
  },
  {
    title: "ÊäòÊâ£‰ª∑Ê†ºüí∞",
    dataIndex: "gameDiscountedPrices",
    key: "gameDiscountedPrices",
    customRender: ({ record }: { record: GameTableRecord }) => {
      if (record.gameOnSale === 1 && record.gameDiscountedPrices !== null) {
        return `¬•${Number(record.gameDiscountedPrices).toFixed(2)}`;
      }
      return "-"; // Ê≤°ÊúâÊäòÊâ£Êó∂ÊòæÁ§∫ "-"
    },
  },
  {
    title: "Áä∂ÊÄÅüîÑ",
    key: "gameIsRemoved",
  },
  {
    title: "Êìç‰Ωú‚ö°",
    key: "action",
  },
];

// Ë°®Ê†ºÊï∞ÊçÆ
const data = ref([]);

// Ëé∑ÂèñÊ∏∏ÊàèÂàóË°®Êï∞ÊçÆ
const fetchData = async (keyword = "") => {
  const res = await searchGames({
    gameName: keyword,
    current: 1,
    pageSize: 10,
  });
  if (res.data.code === 0) {
    data.value = res.data.data?.records || [];
  } else {
    message.error("Ê∏∏ÊàèÊï∞ÊçÆËé∑ÂèñÂ§±Ë¥•");
    data.value = [];
  }
};

interface GameRecord {
  gameId: string | number;
  gameIsRemoved: boolean;
}

// ÂàáÊç¢Ê∏∏Êàè‰∏ä‰∏ãÊû∂Áä∂ÊÄÅ
const toggleStatus = async (record: GameRecord) => {
  try {
    // Ê†πÊçÆÂΩìÂâçÁä∂ÊÄÅÂÜ≥ÂÆöÊñ∞Áä∂ÊÄÅÔºöÂ¶ÇÊûúÂ∑≤‰∏ãÊû∂ÔºàtrueÔºâÔºåÂàô‰∏äÊû∂Ôºà0ÔºâÔºõÂê¶Âàô‰∏ãÊû∂Ôºà1Ôºâ
    const newStatus = record.gameIsRemoved ? 0 : 1;

    // Ë∞ÉÁî®Êé•Âè£Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
    const res = await updateGameStatus({
      gameId: record.gameId, // Ê∏∏ÊàèID
      status: newStatus, // Êñ∞Áä∂ÊÄÅ
    });

    // Âà§Êñ≠Êìç‰ΩúÊòØÂê¶ÊàêÂäü
    if (res.data.code === 0) {
      message.success(`${newStatus === 1 ? "‰∏ãÊû∂" : "‰∏äÊû∂"}ÊàêÂäü`);
      record.gameIsRemoved = Boolean(newStatus); // ‰ΩøÁî® Boolean ËΩ¨Êç¢,Êõ¥Êñ∞Êú¨Âú∞Áä∂ÊÄÅ
      await fetchData(searchValue.value); // Âà∑Êñ∞Êï∞ÊçÆ
    } else {
      message.error(`Êìç‰ΩúÂ§±Ë¥•Ôºö${res.data.message || "Êú™Áü•ÈîôËØØ"}`);
    }
  } catch (error) {
    message.error("ËØ∑Ê±ÇÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
  }
};

// ÁºñËæëÊ®°ÊÄÅÊ°ÜÁõ∏ÂÖ≥Áä∂ÊÄÅ
const modalVisible = ref(false);
const modalTitle = ref("");

// ‰øÆÊîπË°®ÂçïÁä∂ÊÄÅÁöÑÁ±ªÂûãÂÆö‰πâ
interface FormState {
  gameId: string | number;
  gameName: string;
  gameDescription: string;
  gamePrice: number;
  gameStock: number;
  gamePub: string;
  gameReleaseDate: dayjs.Dayjs | null; // any ÊàñËÄÖ‰ΩøÁî® dayjs.Dayjs | null Êõ¥‰∏•Ê†º
  gameDev: string;
  gameIsRemoved: boolean;
  gameOnSale: boolean;
  gameSaleStartTime: dayjs.Dayjs | null; // any ÊàñËÄÖ‰ΩøÁî® dayjs.Dayjs | null Êõ¥‰∏•Ê†º
  gameSaleEndTime: dayjs.Dayjs | null; // any ÊàñËÄÖ‰ΩøÁî® dayjs.Dayjs | null Êõ¥‰∏•Ê†º
  gameDiscount: number;
  gameCover: string; // Êñ∞Â¢ûÊ∏∏ÊàèÂ∞ÅÈù¢Â≠óÊÆµ
}

// ‰øÆÊîπË°®ÂçïÁä∂ÊÄÅÂàùÂßãÂåñ
const formState = reactive<FormState>({
  gameId: "",
  gameName: "",
  gameDescription: "",
  gamePrice: 0,
  gameStock: 0,
  gamePub: "",
  gameReleaseDate: null,
  gameDev: "",
  gameIsRemoved: false,
  gameOnSale: false,
  gameSaleStartTime: null,
  gameSaleEndTime: null,
  gameDiscount: 0,
  gameCover: "", // Êñ∞Â¢ûÊ∏∏ÊàèÂ∞ÅÈù¢Â≠óÊÆµ
});

// ÊòæÁ§∫ÁºñËæëÊ®°ÊÄÅÊ°Ü
const showEditModal = (record: any) => {
  modalTitle.value = "ÁºñËæëÊ∏∏Êàè";
  const formData = {
    ...record,
    gameReleaseDate: record.gameReleaseDate
      ? dayjs(record.gameReleaseDate)
      : null,
    gameCover: record.gameCover, // Êñ∞Â¢ûÊ∏∏ÊàèÂ∞ÅÈù¢Â≠óÊÆµ
    // Ê∑ªÂä†ÊâìÊäòÁõ∏ÂÖ≥Â≠óÊÆµ
    gameSaleStartTime: record.gameSaleStartTime
      ? dayjs(record.gameSaleStartTime)
      : null,
    gameSaleEndTime: record.gameSaleEndTime
      ? dayjs(record.gameSaleEndTime)
      : null,
    // Ê†πÊçÆÊäòÊâ£ÂÄºËá™Âä®ËÆæÁΩÆÊòØÂê¶ÊâìÊäò
    gameOnSale: record.gameDiscount > 0,
    gameDiscount: record.gameDiscount || 0,
  };
  Object.assign(formState, formData);
  modalVisible.value = true;
};

// Â§ÑÁêÜÊ®°ÊÄÅÊ°ÜÁ°ÆËÆ§
const handleModalOk = async () => {
  if (!formState.gameId) {
    message.error("Ê∏∏ÊàèID‰∏çËÉΩ‰∏∫Á©∫");
    return;
  }

  try {
    const updateData = {
      gameId: formState.gameId,
      gameName: formState.gameName,
      gameDescription: formState.gameDescription,
      gamePrice: formState.gamePrice,
      gameStock: formState.gameStock,
      gamePub: formState.gamePub,
      gameDev: formState.gameDev,
      gameReleaseDate: formState.gameReleaseDate
        ? formState.gameReleaseDate.format("YYYY-MM-DD")
        : null,
      gameCover: formState.gameCover, // Êñ∞Â¢ûÊ∏∏ÊàèÂ∞ÅÈù¢Â≠óÊÆµ
      gameOnSale: formState.gameOnSale,
      gameDiscount: formState.gameDiscount,
      gameSaleStartTime: formState.gameSaleStartTime?.toDate() || null,
      gameSaleEndTime: formState.gameSaleEndTime?.toDate() || null,
    };

    const res = await updateGame(updateData);
    if (res.data.code === 0) {
      message.success("Êõ¥Êñ∞ÊàêÂäü");
      modalVisible.value = false;
      await fetchData(searchValue.value);
    } else {
      message.error(res.data.message || "Êõ¥Êñ∞Â§±Ë¥•");
    }
  } catch (error) {
    message.error("Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
  }
};

// Â§ÑÁêÜÊ®°ÊÄÅÊ°ÜÂèñÊ∂àÔºåÈáçÁΩÆË°®Âçï
const handleModalCancel = () => {
  modalVisible.value = false;
  Object.assign(formState, {
    gameId: "",
    gameName: "",
    gameDescription: "",
    gamePrice: 0,
    gameStock: 0,
    gamePub: "",
    gameReleaseDate: null,
    gameDev: "",
    gameOnSale: false,
    gameSaleStartTime: null,
    gameSaleEndTime: null,
    gameDiscount: 0,
  });
};

// Âú® script ÈÉ®ÂàÜÊ∑ªÂä†È™åËØÅÂáΩÊï∞
const validateEndTime = (_rule: any, value: any) => {
  if (formState.gameSaleStartTime && value) {
    if (value.isBefore(formState.gameSaleStartTime)) {
      return Promise.reject("ÁªìÊùüÊó∂Èó¥‰∏çËÉΩÊó©‰∫éÂºÄÂßãÊó∂Èó¥");
    }
  }
  return Promise.resolve();
};

// Â§ÑÁêÜÊòØÂê¶ÊâìÊäòÂºÄÂÖ≥ÂèòÂåñ
const handleSaleStatusChange = async (checked: boolean) => {
  if (!checked) {
    formState.gameDiscount = 0;
    formState.gameSaleStartTime = null;
    formState.gameSaleEndTime = null;
  }
};

// ‰øÆÊîπÊäòÊâ£ÂÄºÂèòÂåñÁöÑÂ§ÑÁêÜÂáΩÊï∞
const handleDiscountChange = (value: number) => {
  // ÂΩìËæìÂÖ•ÊäòÊâ£ÂÄºÊó∂ÔºåÂè™Êõ¥Êñ∞ÂºÄÂÖ≥Áä∂ÊÄÅ
  formState.gameOnSale = value > 0;

  // Âè™ÊúâÂΩìÊäòÊâ£ÂÄº‰∏∫0‰∏îÊòØÁî®Êà∑ÊâãÂä®ËæìÂÖ•ÁöÑÊÉÖÂÜµ‰∏ãÊâçÊ∏ÖÁ©∫Êó∂Èó¥
  if (value === 0 && !formState.gameOnSale) {
    formState.gameSaleStartTime = null;
    formState.gameSaleEndTime = null;
  }
};

// ÁõëÂê¨ÂºÄÂßãÊó∂Èó¥ÂèòÂåñÔºåÈáçÁΩÆÁªìÊùüÊó∂Èó¥ÁöÑÈ™åËØÅ
const handleStartTimeChange = () => {
  if (formState.gameSaleEndTime) {
    validateEndTime(null, formState.gameSaleEndTime);
  }
};

// Êñá‰ª∂‰∏ä‰º†ÂâçÁöÑÂ§ÑÁêÜ
const beforeUpload = (file: File) => {
  const isJpgOrPng = file.type === "image/jpeg" || file.type === "image/png";
  if (!isJpgOrPng) {
    message.error("You can only upload JPG or PNG file!");
  }
  const isLt2M = file.size / 1024 / 1024 < 2;
  if (!isLt2M) {
    message.error("Image must smaller than 2MB!");
  }
  return isJpgOrPng && isLt2M;
};

// Êñá‰ª∂‰∏ä‰º†ÂêéÁöÑÂ§ÑÁêÜ
const handleChange = (info: any) => {
  if (info.file.status === "uploading") {
    return;
  }
  if (info.file.status === "done") {
    // Get this url from response in real world.
    formState.gameCover = info.file.response.url;
  }
};

// ÂàùÂßãÂåñÂä†ËΩΩÊï∞ÊçÆ
fetchData();
</script>

<style scoped>
.avatar-uploader > .ant-upload {
  width: 128px;
  height: 128px;
}

.ant-upload-select-picture-card i {
  font-size: 32px;
  color: #999;
}

.ant-upload-select-picture-card .ant-upload-text {
  margin-top: 8px;
  color: #666;
}
</style>
